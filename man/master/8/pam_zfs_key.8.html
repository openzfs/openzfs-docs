

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pam_zfs_key.8 &mdash; OpenZFS  documentation</title>
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/mandoc.css" type="text/css" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="canonical" href="https://openzfs.github.io/openzfs-docs/man/master/8/pam_zfs_key.8.html" />
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../../../_static/js/redirect.js?v=2a1712f3"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="vdev_id.8" href="vdev_id.8.html" />
    <link rel="prev" title="mount.zfs.8" href="mount.zfs.8.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #29667e" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/logo_main.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../Getting%20Started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Project%20and%20Community/index.html">Project and Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developer%20Resources/index.html">Developer Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Performance%20and%20Tuning/index.html">Performance and Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Basic%20Concepts/index.html">Basic Concepts</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Man Pages</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">master</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../1/index.html">User Commands (1)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../4/index.html">Devices and Special Files (4)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../5/index.html">File Formats and Conventions (5)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../7/index.html">Miscellaneous (7)</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">System Administration Commands (8)</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="fsck.zfs.8.html">fsck.zfs.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="mount.zfs.8.html">mount.zfs.8</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">pam_zfs_key.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="vdev_id.8.html">vdev_id.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zdb.8.html">zdb.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zed.8.html">zed.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-allow.8.html">zfs-allow.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-bookmark.8.html">zfs-bookmark.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-change-key.8.html">zfs-change-key.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-clone.8.html">zfs-clone.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-create.8.html">zfs-create.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-destroy.8.html">zfs-destroy.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-diff.8.html">zfs-diff.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-get.8.html">zfs-get.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-groupspace.8.html">zfs-groupspace.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-hold.8.html">zfs-hold.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-inherit.8.html">zfs-inherit.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-jail.8.html">zfs-jail.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-list.8.html">zfs-list.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-load-key.8.html">zfs-load-key.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-mount-generator.8.html">zfs-mount-generator.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-mount.8.html">zfs-mount.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-program.8.html">zfs-program.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-project.8.html">zfs-project.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-projectspace.8.html">zfs-projectspace.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-promote.8.html">zfs-promote.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-receive.8.html">zfs-receive.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-recv.8.html">zfs-recv.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-redact.8.html">zfs-redact.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-release.8.html">zfs-release.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-rename.8.html">zfs-rename.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-rewrite.8.html">zfs-rewrite.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-rollback.8.html">zfs-rollback.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-send.8.html">zfs-send.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-set.8.html">zfs-set.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-share.8.html">zfs-share.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-snapshot.8.html">zfs-snapshot.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-unallow.8.html">zfs-unallow.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-unjail.8.html">zfs-unjail.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-unload-key.8.html">zfs-unload-key.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-unmount.8.html">zfs-unmount.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-unzone.8.html">zfs-unzone.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-upgrade.8.html">zfs-upgrade.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-userspace.8.html">zfs-userspace.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-wait.8.html">zfs-wait.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs-zone.8.html">zfs-zone.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs.8.html">zfs.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs_ids_to_path.8.html">zfs_ids_to_path.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zfs_prepare_disk.8.html">zfs_prepare_disk.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zgenhostid.8.html">zgenhostid.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zinject.8.html">zinject.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-add.8.html">zpool-add.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-attach.8.html">zpool-attach.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-checkpoint.8.html">zpool-checkpoint.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-clear.8.html">zpool-clear.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-create.8.html">zpool-create.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-ddtprune.8.html">zpool-ddtprune.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-destroy.8.html">zpool-destroy.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-detach.8.html">zpool-detach.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-events.8.html">zpool-events.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-export.8.html">zpool-export.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-get.8.html">zpool-get.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-history.8.html">zpool-history.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-import.8.html">zpool-import.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-initialize.8.html">zpool-initialize.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-iostat.8.html">zpool-iostat.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-labelclear.8.html">zpool-labelclear.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-list.8.html">zpool-list.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-offline.8.html">zpool-offline.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-online.8.html">zpool-online.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-prefetch.8.html">zpool-prefetch.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-reguid.8.html">zpool-reguid.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-remove.8.html">zpool-remove.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-reopen.8.html">zpool-reopen.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-replace.8.html">zpool-replace.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-resilver.8.html">zpool-resilver.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-scrub.8.html">zpool-scrub.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-set.8.html">zpool-set.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-split.8.html">zpool-split.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-status.8.html">zpool-status.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-sync.8.html">zpool-sync.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-trim.8.html">zpool-trim.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-upgrade.8.html">zpool-upgrade.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool-wait.8.html">zpool-wait.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool.8.html">zpool.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zpool_influxdb.8.html">zpool_influxdb.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zstream.8.html">zstream.8</a></li>
<li class="toctree-l4"><a class="reference internal" href="zstreamdump.8.html">zstreamdump.8</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../v2.4/index.html">v2.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../v2.3/index.html">v2.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../v2.2/index.html">v2.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../v2.1/index.html">v2.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../v2.0/index.html">v2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../v0.8/index.html">v0.8</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../v0.7/index.html">v0.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../v0.6/index.html">v0.6</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../msg/index.html">ZFS Messages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../License.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #29667e" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">OpenZFS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Man Pages</a></li>
          <li class="breadcrumb-item"><a href="../index.html">master</a></li>
          <li class="breadcrumb-item"><a href="index.html">System Administration Commands (8)</a></li>
      <li class="breadcrumb-item active">pam_zfs_key.8</li>
      <li class="wy-breadcrumbs-aside">
              <!-- User defined GitHub URL -->
              <a href="https://github.com/openzfs/zfs/blob/master/man/man8/pam_zfs_key.8" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="pam-zfs-key-8">
<h1>pam_zfs_key.8<a class="headerlink" href="#pam-zfs-key-8" title="Link to this heading">ÔÉÅ</a></h1>
<div class="man_container"><table class="head">
  <tr>
    <td class="head-ltitle">PAM_ZFS_KEY(8)</td>
    <td class="head-vol">System Manager's Manual</td>
    <td class="head-rtitle">PAM_ZFS_KEY(8)</td>
  </tr>
</table>
<div class="manual-text">
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp"><code class="Nm">pam_zfs_key</code> &#x2014; <span class="Nd">PAM
    module for ZFS encryption key management</span></p>
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<table class="Nm">
  <tr>
    <td><code class="Nm">pam_zfs_key.so</code></td>
    <td>[<var class="Ar">options</var>]</td>
  </tr>
</table>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp"><code class="Nm">pam_zfs_key</code> is a PAM module that
    automatically manages encryption keys for ZFS datasets during user
    authentication and session management. When a user logs in, the module uses
    their password to unlock their encrypted home directory. When the last
    session closes, the module unmounts the dataset and unloads the key.</p>
<p class="Pp">The module tracks active sessions using reference counting to
    support multiple simultaneous logins from the same user.</p>
<section class="Ss">
<h2 class="Ss" id="Multiple_Home_Prefixes"><a class="permalink" href="#Multiple_Home_Prefixes">Multiple
  Home Prefixes</a></h2>
<p class="Pp">When configured with multiple home prefixes, the module attempts
    operations on all matching datasets. Operations that succeed are not rolled
    back if others fail. The module returns success only if all operations
    succeed.</p>
<p class="Pp">For example, with datasets 1, 2, 3 where dataset 2 fails:</p>
<ul class="Bl-bullet Bl-compact">
  <li>Auth/session: datasets 1 and 3 are unlocked and mounted, dataset 2 is
    not.</li>
  <li>Password change: datasets 1 and 3 have the new password, dataset 2 retains
      the old.</li>
</ul>
<p class="Pp">With <b class="Sy">required</b>, login fails even though datasets
    1 and 3 succeeded. With <b class="Sy">optional</b>, login proceeds. For
    password changes, datasets 1 and 3 are updated while dataset 2 retains the
    old password. With <b class="Sy">required</b>, the user sees an error. With
    <b class="Sy">optional</b>, the user sees success and may not notice the
    inconsistency. Either way, passwords are left out of sync.</p>
<p class="Pp">Errors are logged to syslog. Use
    <a href="../8/zfs-change-key.8.html" class="Xr">zfs-change-key(8)</a> to resync passwords after partial
    failure.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="OPTIONS"><a class="permalink" href="#OPTIONS">OPTIONS</a></h1>
<dl class="Bl-tag">
  <dt id="homes"><a class="permalink" href="#homes"><b class="Sy">homes</b></a>=<var class="Ar">path</var>[,<var class="Ar">path2</var>...]</dt>
  <dd>Comma-separated list of dataset prefixes where user home directories are
      located. The module constructs the full dataset path as
      <var class="Ar">prefix</var>/<var class="Ar">username</var>. Default:
      <a class="permalink" href="#zroot/home"><b class="Sy" id="zroot/home">zroot/home</b></a>
      on <span class="Ux">FreeBSD</span>, <b class="Sy">rpool/home</b> on
    Linux.</dd>
  <dt id="runstatedir"><a class="permalink" href="#runstatedir"><b class="Sy">runstatedir</b></a>=<var class="Ar">path</var></dt>
  <dd>Directory for storing session reference counts. Default:
      <span class="Pa">/var/run/pam_zfs_key</span>.</dd>
  <dt id="uid_min"><a class="permalink" href="#uid_min"><b class="Sy">uid_min</b></a>=<var class="Ar">uid</var></dt>
  <dd>Minimum user ID for which the module will operate. Default: 1000.</dd>
  <dt id="uid_max"><a class="permalink" href="#uid_max"><b class="Sy">uid_max</b></a>=<var class="Ar">uid</var></dt>
  <dd>Maximum user ID for which the module will operate. Default: MAXUID.</dd>
  <dt id="nounmount"><a class="permalink" href="#nounmount"><b class="Sy">nounmount</b></a></dt>
  <dd>Do not unmount datasets or unload encryption keys when sessions close.
      Datasets remain mounted and keys remain loaded.</dd>
  <dt id="forceunmount"><a class="permalink" href="#forceunmount"><b class="Sy">forceunmount</b></a></dt>
  <dd>Force unmount datasets even if busy
    (<code class="Dv">MS_FORCE</code>).</dd>
  <dt id="recursive_homes"><a class="permalink" href="#recursive_homes"><b class="Sy">recursive_homes</b></a></dt>
  <dd>Recursively search for encrypted datasets under the homes prefix.</dd>
  <dt id="mount_recursively"><a class="permalink" href="#mount_recursively"><b class="Sy">mount_recursively</b></a></dt>
  <dd>Mount and unmount child datasets recursively.</dd>
  <dt id="prop_mountpoint"><a class="permalink" href="#prop_mountpoint"><b class="Sy">prop_mountpoint</b></a></dt>
  <dd>Find the user's dataset by matching the dataset's
      <b class="Sy">mountpoint</b> property to the user's home directory from
      <span class="Pa">/etc/passwd</span>, instead of constructing the dataset
      name as <var class="Ar">prefix</var>/<var class="Ar">username</var>.</dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="FILES"><a class="permalink" href="#FILES">FILES</a></h1>
<dl class="Bl-tag">
  <dt><span class="Pa">/var/run/pam_zfs_key/</span><var class="Ar">uid</var></dt>
  <dd>Session reference count files tracking active logins per user.</dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="EXAMPLES"><a class="permalink" href="#EXAMPLES">EXAMPLES</a></h1>
<section class="Ss">
<h2 class="Ss" id="Example_1:_Basic_Configuration"><a class="permalink" href="#Example_1:_Basic_Configuration">Example
  1: Basic Configuration</a></h2>
<p class="Pp">Add to <span class="Pa">/etc/pam.d/system-auth</span>:</p>
<div class="Bd Pp Bd-indent Li">
<pre>auth     optional  pam_zfs_key.so
password optional  pam_zfs_key.so
session  optional  pam_zfs_key.so</pre>
</div>
<p class="Pp" id="zroot/home/">This configuration uses default settings. User
    home datasets are expected at
    <a class="permalink" href="#zroot/home/"><b class="Sy">zroot/home/</b></a><var class="Ar">username</var>
    on <span class="Ux">FreeBSD</span> or
    <a class="permalink" href="#rpool/home/"><b class="Sy" id="rpool/home/">rpool/home/</b></a><var class="Ar">username</var>
    on Linux.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Example_2:_Custom_Home_Directory_Prefix"><a class="permalink" href="#Example_2:_Custom_Home_Directory_Prefix">Example
  2: Custom Home Directory Prefix</a></h2>
<div class="Bd Bd-indent Li">
<pre>auth     optional  pam_zfs_key.so homes=tank/users
password optional  pam_zfs_key.so homes=tank/users
session  optional  pam_zfs_key.so homes=tank/users</pre>
</div>
<p class="Pp" id="tank/users/">Looks for user datasets at
    <a class="permalink" href="#tank/users/"><b class="Sy">tank/users/</b></a><var class="Ar">username</var>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Example_3:_Multiple_Dataset_Prefixes"><a class="permalink" href="#Example_3:_Multiple_Dataset_Prefixes">Example
  3: Multiple Dataset Prefixes</a></h2>
<div class="Bd Bd-indent Li">
<pre>session  optional  pam_zfs_key.so homes=rpool/home,tank/users</pre>
</div>
<p class="Pp" id="tank/users">Searches for user datasets in both
    <b class="Sy">rpool/home</b> and
    <a class="permalink" href="#tank/users"><b class="Sy">tank/users</b></a>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Example_4:_Keep_Datasets_Mounted"><a class="permalink" href="#Example_4:_Keep_Datasets_Mounted">Example
  4: Keep Datasets Mounted</a></h2>
<div class="Bd Bd-indent Li">
<pre>session  optional  pam_zfs_key.so nounmount</pre>
</div>
<p class="Pp">Leaves datasets mounted and keys loaded when sessions close.
    Useful for systems with background processes accessing the home
  directory.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Example_5:_Recursive_Mounting"><a class="permalink" href="#Example_5:_Recursive_Mounting">Example
  5: Recursive Mounting</a></h2>
<div class="Bd Bd-indent Li">
<pre>session  optional  pam_zfs_key.so mount_recursively</pre>
</div>
<p class="Pp" id="rpool/home/alice/documents">Mounts child datasets recursively,
    useful when user data is organized hierarchically like
    <a class="permalink" href="#rpool/home/alice/documents"><b class="Sy">rpool/home/alice/documents</b></a>
    and
    <a class="permalink" href="#rpool/home/alice/photos"><b class="Sy" id="rpool/home/alice/photos">rpool/home/alice/photos</b></a>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Example_6:_Creating_an_Encrypted_Home_Dataset"><a class="permalink" href="#Example_6:_Creating_an_Encrypted_Home_Dataset">Example
  6: Creating an Encrypted Home Dataset</a></h2>
<div class="Bd Bd-indent Li">
<pre># zfs create -o encryption=on \
    -o keyformat=passphrase \
    -o keylocation=prompt \
    -o canmount=on \
    -o mountpoint=/home/alice \
    rpool/home/alice</pre>
</div>
<p class="Pp" id="on">The user's login password must match the dataset
    passphrase for automatic unlocking to work. The dataset must have a
    ZFS-managed mountpoint (not legacy) and
    <b class="Sy">canmount</b>=<a class="permalink" href="#on"><b class="Sy">on</b></a>
    for automatic mounting.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Example_7:_Multiple_Homes_with_Password_Sync_Check"><a class="permalink" href="#Example_7:_Multiple_Homes_with_Password_Sync_Check">Example
  7: Multiple Homes with Password Sync Check</a></h2>
<div class="Bd Bd-indent Li">
<pre>auth     optional  pam_zfs_key.so homes=rpool/home,tank/home
password required  pam_zfs_key.so homes=rpool/home,tank/home
session  optional  pam_zfs_key.so homes=rpool/home,tank/home</pre>
</div>
<p class="Pp">Login proceeds even if some datasets are unavailable. Password
    changes fail if any dataset cannot be updated, ensuring the user is notified
    of sync issues. See <a class="Sx" href="#Multiple_Home_Prefixes">Multiple
    Home Prefixes</a> for failure behavior.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="SEE_ALSO"><a class="permalink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<p class="Pp"><a href="../8/zfs-change-key.8.html" class="Xr">zfs-change-key(8)</a>,
    <a href="../8/zfs-load-key.8.html" class="Xr">zfs-load-key(8)</a>, <a href="../8/zfs-mount.8.html" class="Xr">zfs-mount(8)</a></p>
</section>
<section class="Sh">
<h1 class="Sh" id="NOTES"><a class="permalink" href="#NOTES">NOTES</a></h1>
<ul class="Bl-bullet Bl-compact">
  <li id="keyformat">Only works with datasets using
      <a class="permalink" href="#keyformat"><b class="Sy">keyformat</b></a>=<a class="permalink" href="#passphrase"><b class="Sy" id="passphrase">passphrase</b></a>.</li>
  <li id="keylocation">Datasets must have
      <a class="permalink" href="#keylocation"><b class="Sy">keylocation</b></a>=<a class="permalink" href="#prompt"><b class="Sy" id="prompt">prompt</b></a>.</li>
  <li id="legacy">Datasets with
      <b class="Sy">mountpoint</b>=<a class="permalink" href="#legacy"><b class="Sy">legacy</b></a>,
      <b class="Sy">canmount</b>=<a class="permalink" href="#off"><b class="Sy" id="off">off</b></a>,
      or
      <b class="Sy">canmount</b>=<a class="permalink" href="#noauto"><b class="Sy" id="noauto">noauto</b></a>
      will have keys loaded but not be automatically mounted.</li>
</ul>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">December 24, 2025</td>
    <td class="foot-os">Debian</td>
  </tr>
</table>
</div></section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mount.zfs.8.html" class="btn btn-neutral float-left" title="mount.zfs.8" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="vdev_id.8.html" class="btn btn-neutral float-right" title="vdev_id.8" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, OpenZFS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>