

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta property="article:modified_time" content="2026-01-25T12:03:27+00:00" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ubuntu 20.04 Root on ZFS for Raspberry Pi &mdash; OpenZFS  documentation</title>
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/mandoc.css" type="text/css" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="canonical" href="https://openzfs.github.io/openzfs-docs/Getting%20Started/Ubuntu/Ubuntu%2020.04%20Root%20on%20ZFS%20for%20Raspberry%20Pi.html" />
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../../_static/js/redirect.js?v=2a1712f3"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Ubuntu 22.04 Root on ZFS" href="Ubuntu%2022.04%20Root%20on%20ZFS.html" />
    <link rel="prev" title="Ubuntu 20.04 Root on ZFS" href="Ubuntu%2020.04%20Root%20on%20ZFS.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #29667e" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/logo_main.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Alpine%20Linux/index.html">Alpine Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Arch%20Linux/index.html">Arch Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Debian/index.html">Debian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fedora/index.html">Fedora</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FreeBSD.html">FreeBSD</a></li>
<li class="toctree-l2"><a class="reference external" href="https://wiki.gentoo.org/wiki/ZFS">Gentoo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../NixOS/index.html">NixOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../openSUSE/index.html">openSUSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../RHEL-based%20distro/index.html">RHEL-based distro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Slackware/index.html">Slackware</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Ubuntu</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="index.html#installation">Installation</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html#root-on-zfs">Root on ZFS</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="Ubuntu%2018.04%20Root%20on%20ZFS.html">Ubuntu 18.04 Root on ZFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="Ubuntu%2020.04%20Root%20on%20ZFS.html">Ubuntu 20.04 Root on ZFS</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Ubuntu 20.04 Root on ZFS for Raspberry Pi</a></li>
<li class="toctree-l4"><a class="reference internal" href="Ubuntu%2022.04%20Root%20on%20ZFS.html">Ubuntu 22.04 Root on ZFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="Ubuntu%2022.04%20Root%20on%20ZFS%20for%20Raspberry%20Pi.html">Ubuntu 22.04 Root on ZFS for Raspberry Pi</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Project%20and%20Community/index.html">Project and Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Developer%20Resources/index.html">Developer Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Performance%20and%20Tuning/index.html">Performance and Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Basic%20Concepts/index.html">Basic Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../man/index.html">Man Pages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../msg/index.html">ZFS Messages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../License.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #29667e" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OpenZFS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Getting Started</a></li>
          <li class="breadcrumb-item"><a href="index.html">Ubuntu</a></li>
      <li class="breadcrumb-item active">Ubuntu 20.04 Root on ZFS for Raspberry Pi</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/openzfs/openzfs-docs/blob/master/docs/Getting Started/Ubuntu/Ubuntu 20.04 Root on ZFS for Raspberry Pi.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ubuntu-20-04-root-on-zfs-for-raspberry-pi">
<h1>Ubuntu 20.04 Root on ZFS for Raspberry Pi<a class="headerlink" href="#ubuntu-20-04-root-on-zfs-for-raspberry-pi" title="Link to this heading"></a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id1">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#newer-release-available" id="id2">Newer release available</a></p></li>
<li><p><a class="reference internal" href="#caution" id="id3">Caution</a></p></li>
<li><p><a class="reference internal" href="#system-requirements" id="id4">System Requirements</a></p></li>
<li><p><a class="reference internal" href="#support" id="id5">Support</a></p></li>
<li><p><a class="reference internal" href="#contributing" id="id6">Contributing</a></p></li>
<li><p><a class="reference internal" href="#encryption" id="id7">Encryption</a></p></li>
<li><p><a class="reference internal" href="#usb-disks" id="id8">USB Disks</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#step-1-disk-formatting" id="id9">Step 1: Disk Formatting</a></p></li>
<li><p><a class="reference internal" href="#step-2-setup-zfs" id="id10">Step 2: Setup ZFS</a></p></li>
<li><p><a class="reference internal" href="#step-3-system-installation" id="id11">Step 3: System Installation</a></p></li>
<li><p><a class="reference internal" href="#step-4-system-configuration" id="id12">Step 4: System Configuration</a></p></li>
<li><p><a class="reference internal" href="#step-5-first-boot" id="id13">Step 5: First Boot</a></p></li>
<li><p><a class="reference internal" href="#step-6-full-software-installation" id="id14">Step 6: Full Software Installation</a></p></li>
<li><p><a class="reference internal" href="#step-7-final-cleanup" id="id15">Step 7: Final Cleanup</a></p></li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Overview</a><a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<section id="newer-release-available">
<h3><a class="toc-backref" href="#id2" role="doc-backlink">Newer release available</a><a class="headerlink" href="#newer-release-available" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>See <a class="reference internal" href="Ubuntu%2022.04%20Root%20on%20ZFS%20for%20Raspberry%20Pi.html"><span class="doc">Ubuntu 22.04 Root on ZFS for Raspberry Pi</span></a> for new installs. This guide
is no longer receiving most updates.  It continues to exist for reference
for existing installs that followed it.</p></li>
</ul>
</section>
<section id="caution">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Caution</a><a class="headerlink" href="#caution" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>This HOWTO uses a whole physical disk.</p></li>
<li><p>Backup your data. Any existing data will be lost.</p></li>
</ul>
</section>
<section id="system-requirements">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">System Requirements</a><a class="headerlink" href="#system-requirements" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>A Raspberry Pi 4 B. (If you are looking to install on a regular PC, see
<a class="reference internal" href="Ubuntu%2020.04%20Root%20on%20ZFS.html"><span class="doc">Ubuntu 20.04 Root on ZFS</span></a>.)</p></li>
<li><p><a class="reference external" href="https://cdimage.ubuntu.com/releases/20.04.4/release/ubuntu-20.04.4-preinstalled-server-arm64+raspi.img.xz">Ubuntu Server 20.04.4 (“Focal”) for Raspberry Pi 4</a></p></li>
<li><p>A microSD card or USB disk. For microSD card recommendations, see Jeff
Geerling’s <a class="reference external" href="https://www.jeffgeerling.com/blog/2019/raspberry-pi-microsd-card-performance-comparison-2019">performance comparison</a>.
When using a USB enclosure, <a class="reference external" href="https://github.com/geerlingguy/turing-pi-cluster/issues/11#issuecomment-647726561">ensure it supports UASP</a>.</p></li>
<li><p>An Ubuntu system (with the ability to write to the microSD card or USB disk)
other than the target Raspberry Pi.</p></li>
</ul>
<p>4 GiB of memory is recommended. Do not use deduplication, as it needs <a class="reference external" href="http://wiki.freebsd.org/ZFSTuningGuide#Deduplication">massive
amounts of RAM</a>.
Enabling deduplication is a permanent change that cannot be easily reverted.</p>
<p>A Raspberry Pi 3 B/B+ would probably work (as the Pi 3 is 64-bit, though it
has less RAM), but has not been tested.  Please report your results (good or
bad) using the issue link below.</p>
</section>
<section id="support">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Support</a><a class="headerlink" href="#support" title="Link to this heading"></a></h3>
<p>If you need help, reach out to the community using the <a class="reference internal" href="../../Project%20and%20Community/Mailing%20Lists.html#mailing-lists"><span class="std std-ref">Mailing Lists</span></a> or IRC at
<a class="reference external" href="ircs://irc.libera.chat/#zfsonlinux">#zfsonlinux</a> on <a class="reference external" href="https://libera.chat/">Libera Chat</a>. If you have a bug report or feature request
related to this HOWTO, please <a class="reference external" href="https://github.com/openzfs/openzfs-docs/issues/new?body=&#64;rlaager,%20I%20have%20the%20following%20issue%20with%20the%20Ubuntu%2020.04%20Root%20on%20ZFS%20for%20Raspberry%20Pi%20HOWTO:">file a new issue and mention &#64;rlaager</a>.</p>
</section>
<section id="contributing">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Contributing</a><a class="headerlink" href="#contributing" title="Link to this heading"></a></h3>
<ol class="arabic">
<li><p>Fork and clone: <a class="reference external" href="https://github.com/openzfs/openzfs-docs">https://github.com/openzfs/openzfs-docs</a></p></li>
<li><p>Install the tools:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>python3-pip

pip3<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>docs/requirements.txt

<span class="c1"># Add ~/.local/bin to your $PATH, e.g. by adding this to ~/.bashrc:</span>
<span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/.local/bin:<span class="nv">$PATH</span>
</pre></div>
</div>
</li>
<li><p>Make your changes.</p></li>
<li><p>Test:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>docs
make<span class="w"> </span>html
sensible-browser<span class="w"> </span>_build/html/index.html
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">--signoff</span></code> to a branch, <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span></code>, and create a pull
request. Mention &#64;rlaager.</p></li>
</ol>
</section>
<section id="encryption">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Encryption</a><a class="headerlink" href="#encryption" title="Link to this heading"></a></h3>
<p><strong>WARNING:</strong> Encryption has not yet been tested on the Raspberry Pi.</p>
<p>This guide supports three different encryption options: unencrypted, ZFS
native encryption, and LUKS. With any option, all ZFS features are fully
available.</p>
<p>Unencrypted does not encrypt anything, of course. With no encryption
happening, this option naturally has the best performance.</p>
<p>ZFS native encryption encrypts the data and most metadata in the root
pool. It does not encrypt dataset or snapshot names or properties. The
boot pool is not encrypted at all, but it only contains the bootloader,
kernel, and initrd. (Unless you put a password in <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>, the
initrd is unlikely to contain sensitive data.) The system cannot boot
without the passphrase being entered at the console. Performance is
good. As the encryption happens in ZFS, even if multiple disks (mirror
or raidz topologies) are used, the data only has to be encrypted once.</p>
<p>LUKS encrypts almost everything. The only unencrypted data is the bootloader,
kernel, and initrd. The system cannot boot without the passphrase being
entered at the console. Performance is good, but LUKS sits underneath ZFS, so
if multiple disks (mirror or raidz topologies) are used, the data has to be
encrypted once per disk.</p>
</section>
<section id="usb-disks">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">USB Disks</a><a class="headerlink" href="#usb-disks" title="Link to this heading"></a></h3>
<p>The Raspberry Pi 4 runs much faster using a USB Solid State Drive (SSD) than
a microSD card. These instructions can also be used to install Ubuntu on a
USB-connected SSD or other USB disk. USB disks have three requirements that
do not apply to microSD cards:</p>
<ol class="arabic">
<li><p>The Raspberry Pi’s Bootloader EEPROM must be dated 2020-09-03 or later.</p>
<p>To check the bootloader version, power up the Raspberry Pi without an SD
card inserted or a USB boot device attached; the date will be on the
<code class="docutils literal notranslate"><span class="pre">bootloader</span></code> line. (If you do not see the <code class="docutils literal notranslate"><span class="pre">bootloader</span></code> line, the
bootloader is too old.) Alternatively, run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">rpi-eeprom-update</span></code>
on an existing OS on the Raspberry Pi (which on Ubuntu requires
<code class="docutils literal notranslate"><span class="pre">apt</span> <span class="pre">install</span> <span class="pre">rpi-eeprom</span></code>).</p>
<p>If needed, the bootloader can be updated from an existing OS on the
Raspberry Pi using <code class="docutils literal notranslate"><span class="pre">rpi-eeprom-update</span> <span class="pre">-a</span></code> and rebooting.
For other options, see <a class="reference external" href="https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#updating-the-bootloader">Updating the Bootloader</a>.</p>
</li>
<li><p>The Raspberry Pi must configured for USB boot. The bootloader will show a
<code class="docutils literal notranslate"><span class="pre">boot</span></code> line; if <code class="docutils literal notranslate"><span class="pre">order</span></code> includes <code class="docutils literal notranslate"><span class="pre">4</span></code>, USB boot is enabled.</p>
<p>If not already enabled, it can be enabled from an existing OS on the
Raspberry Pi using <code class="docutils literal notranslate"><span class="pre">rpi-eeprom-config</span> <span class="pre">-e</span></code>: set <code class="docutils literal notranslate"><span class="pre">BOOT_ORDER=0xf41</span></code>
and reboot to apply the change. On subsequent reboots, USB boot will be
enabled.</p>
<p>Otherwise, it can be enabled without an existing OS as follows:</p>
<ul class="simple">
<li><p>Download the <a class="reference external" href="https://www.raspberrypi.com/news/raspberry-pi-imager-imaging-utility/">Raspberry Pi Imager Utility</a>.</p></li>
<li><p>Flash the <code class="docutils literal notranslate"><span class="pre">USB</span> <span class="pre">Boot</span></code> image to a microSD card. The <code class="docutils literal notranslate"><span class="pre">USB</span> <span class="pre">Boot</span></code> image is
listed under <code class="docutils literal notranslate"><span class="pre">Bootloader</span></code> in the <code class="docutils literal notranslate"><span class="pre">Misc</span> <span class="pre">utility</span> <span class="pre">images</span></code> folder.</p></li>
<li><p>Boot the Raspberry Pi from the microSD card. USB Boot should be enabled
automatically.</p></li>
</ul>
</li>
<li><p>U-Boot on Ubuntu 20.04 does not seem to support the Raspberry Pi USB.
<a class="reference external" href="https://forums.raspberrypi.com/viewtopic.php?t=295609">Ubuntu 20.10 may work</a>.  As a
work-around, the Raspberry Pi bootloader is configured to directly boot
Linux.  For this to work, the Linux kernel must not be compressed. These
instructions decompress the kernel and add a script to
<code class="docutils literal notranslate"><span class="pre">/etc/kernel/postinst.d</span></code> to handle kernel upgrades.</p></li>
</ol>
</section>
</section>
<section id="step-1-disk-formatting">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Step 1: Disk Formatting</a><a class="headerlink" href="#step-1-disk-formatting" title="Link to this heading"></a></h2>
<p>The commands in this step are run on the system other than the Raspberry Pi.</p>
<p>This guide has you go to some extra work so that the stock ext4 partition can
be deleted.</p>
<ol class="arabic">
<li><p>Download and unpack the official image:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-O<span class="w"> </span>https://cdimage.ubuntu.com/releases/20.04.4/release/ubuntu-20.04.4-preinstalled-server-arm64+raspi.img.xz
xz<span class="w"> </span>-d<span class="w"> </span>ubuntu-20.04.4-preinstalled-server-arm64+raspi.img.xz

<span class="c1"># or combine them to decompress as you download:</span>
curl<span class="w"> </span>https://cdimage.ubuntu.com/releases/20.04.4/release/ubuntu-20.04.4-preinstalled-server-arm64+raspi.img.xz<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>xz<span class="w"> </span>-d<span class="w"> </span>&gt;<span class="w"> </span>ubuntu-20.04.4-preinstalled-server-arm64+raspi.img
</pre></div>
</div>
</li>
<li><p>Dump the partition table for the image:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sfdisk<span class="w"> </span>-d<span class="w"> </span>ubuntu-20.04.4-preinstalled-server-arm64+raspi.img
</pre></div>
</div>
<p>That will output this:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>label:<span class="w"> </span>dos
label-id:<span class="w"> </span>0xddbefb06
device:<span class="w"> </span>ubuntu-20.04.4-preinstalled-server-arm64+raspi.img
unit:<span class="w"> </span>sectors

&lt;name&gt;.img1<span class="w"> </span>:<span class="w"> </span><span class="nv">start</span><span class="o">=</span><span class="w">        </span><span class="m">2048</span>,<span class="w"> </span><span class="nv">size</span><span class="o">=</span><span class="w">      </span><span class="m">524288</span>,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>c,<span class="w"> </span>bootable
&lt;name&gt;.img2<span class="w"> </span>:<span class="w"> </span><span class="nv">start</span><span class="o">=</span><span class="w">      </span><span class="m">526336</span>,<span class="w"> </span><span class="nv">size</span><span class="o">=</span><span class="w">     </span><span class="m">6285628</span>,<span class="w"> </span><span class="nv">type</span><span class="o">=</span><span class="m">83</span>
</pre></div>
</div>
<p>The important numbers are 524288 and 6285628.  Store those in variables:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">BOOT</span><span class="o">=</span><span class="m">524288</span>
<span class="nv">ROOT</span><span class="o">=</span><span class="m">6285628</span>
</pre></div>
</div>
</li>
<li><p>Create a partition script:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>&gt;<span class="w"> </span>partitions<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s">label: dos</span>
<span class="s">unit: sectors</span>

<span class="s">1 : start=  2048,  size=$BOOT,  type=c, bootable</span>
<span class="s">2 : start=$((2048+BOOT)),  size=$ROOT, type=83</span>
<span class="s">3 : start=$((2048+BOOT+ROOT)), size=$ROOT, type=83</span>
<span class="s">EOF</span>
</pre></div>
</div>
</li>
<li><p>Connect the disk:</p>
<p>Connect the disk to a machine other than the target Raspberry Pi.  If any
filesystems are automatically mounted (e.g. by GNOME) unmount them.
Determine the device name. For SD, the device name is almost certainly
<code class="docutils literal notranslate"><span class="pre">/dev/mmcblk0</span></code>. For USB SSDs, the device name is <code class="docutils literal notranslate"><span class="pre">/dev/sdX</span></code>, where
<code class="docutils literal notranslate"><span class="pre">X</span></code> is a lowercase letter. <code class="docutils literal notranslate"><span class="pre">lsblk</span></code> can help determine the device name.
Set the <code class="docutils literal notranslate"><span class="pre">DISK</span></code> environment variable to the device name:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">DISK</span><span class="o">=</span>/dev/mmcblk0<span class="w">    </span><span class="c1"># microSD card</span>
<span class="nv">DISK</span><span class="o">=</span>/dev/sdX<span class="w">        </span><span class="c1"># USB disk</span>
</pre></div>
</div>
<p>Because partitions are named differently for <code class="docutils literal notranslate"><span class="pre">/dev/mmcblk0</span></code> and <code class="docutils literal notranslate"><span class="pre">/dev/sdX</span></code>
devices, set a second variable used when working with partitions:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">DISKP</span><span class="o">=</span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>p<span class="w"> </span><span class="c1"># microSD card</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">DISKP</span><span class="o">=</span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span><span class="w">  </span><span class="c1"># USB disk ($DISKP == $DISK for /dev/sdX devices)</span>
</pre></div>
</div>
<p><strong>Hint</strong>: microSD cards connected using a USB reader also have <code class="docutils literal notranslate"><span class="pre">/dev/sdX</span></code>
names.</p>
<p><strong>WARNING</strong>: The following steps destroy the existing data on the disk. Ensure
<code class="docutils literal notranslate"><span class="pre">DISK</span></code> and <code class="docutils literal notranslate"><span class="pre">DISKP</span></code> are correct before proceeding.</p>
</li>
<li><p>Ensure swap partitions are not in use:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>swapon<span class="w"> </span>-v
<span class="c1"># If a partition is in use from the disk, disable it:</span>
sudo<span class="w"> </span>swapoff<span class="w"> </span>THAT_PARTITION
</pre></div>
</div>
</li>
<li><p>Clear old ZFS labels:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>zpool<span class="w"> </span>labelclear<span class="w"> </span>-f<span class="w"> </span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>
</pre></div>
</div>
<p>If a ZFS label still exists from a previous system/attempt, expanding the
pool will result in an unbootable system.</p>
<p><strong>Hint:</strong> If you do not already have the ZFS utilities installed, you can
install them with: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">zfsutils-linux</span></code>  Alternatively, you
can zero the entire disk with:
<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">dd</span> <span class="pre">if=/dev/zero</span> <span class="pre">of=${DISK}</span> <span class="pre">bs=1M</span> <span class="pre">status=progress</span></code></p>
</li>
<li><p>Delete existing partitions:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;label: dos&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>sfdisk<span class="w"> </span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>
sudo<span class="w"> </span>partprobe
ls<span class="w"> </span><span class="si">${</span><span class="nv">DISKP</span><span class="si">}</span>*
</pre></div>
</div>
<p>Make sure there are no partitions, just the file for the disk itself.  This
step is not strictly necessary; it exists to catch problems.</p>
</li>
<li><p>Create the partitions:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>sfdisk<span class="w"> </span><span class="nv">$DISK</span><span class="w"> </span>&lt;<span class="w"> </span>partitions
</pre></div>
</div>
</li>
<li><p>Loopback mount the image:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">IMG</span><span class="o">=</span><span class="k">$(</span>sudo<span class="w"> </span>losetup<span class="w"> </span>-fP<span class="w"> </span>--show<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>ubuntu-20.04.4-preinstalled-server-arm64+raspi.img<span class="k">)</span>
</pre></div>
</div>
</li>
<li><p>Copy the bootloader data:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span><span class="si">${</span><span class="nv">IMG</span><span class="si">}</span>p1<span class="w"> </span><span class="nv">of</span><span class="o">=</span><span class="si">${</span><span class="nv">DISKP</span><span class="si">}</span><span class="m">1</span><span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M
</pre></div>
</div>
</li>
<li><p>Clear old label(s) from partition 2:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>wipefs<span class="w"> </span>-a<span class="w"> </span><span class="si">${</span><span class="nv">DISKP</span><span class="si">}</span><span class="m">2</span>
</pre></div>
</div>
<p>If a filesystem with the <code class="docutils literal notranslate"><span class="pre">writable</span></code> label from the Ubuntu image is still
present in partition 2, the system will not boot initially.</p>
</li>
<li><p>Copy the root filesystem data:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># NOTE: the destination is p3, not p2.</span>
sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span><span class="si">${</span><span class="nv">IMG</span><span class="si">}</span>p2<span class="w"> </span><span class="nv">of</span><span class="o">=</span><span class="si">${</span><span class="nv">DISKP</span><span class="si">}</span><span class="m">3</span><span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">status</span><span class="o">=</span>progress<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync
</pre></div>
</div>
</li>
<li><p>Unmount the image:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>losetup<span class="w"> </span>-d<span class="w"> </span><span class="nv">$IMG</span>
</pre></div>
</div>
</li>
<li><p>If setting up a USB disk:</p>
<p>Decompress the kernel:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>-sE

<span class="nv">MNT</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="w"> </span>-d<span class="w"> </span>/mnt/XXXXXXXX<span class="k">)</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$MNT</span>/boot<span class="w"> </span><span class="nv">$MNT</span>/root
mount<span class="w"> </span><span class="si">${</span><span class="nv">DISKP</span><span class="si">}</span><span class="m">1</span><span class="w"> </span><span class="nv">$MNT</span>/boot
mount<span class="w"> </span><span class="si">${</span><span class="nv">DISKP</span><span class="si">}</span><span class="m">3</span><span class="w"> </span><span class="nv">$MNT</span>/root

zcat<span class="w"> </span>-qf<span class="w"> </span><span class="nv">$MNT</span>/boot/vmlinuz<span class="w"> </span>&gt;<span class="nv">$MNT</span>/boot/vmlinux
</pre></div>
</div>
<p>Modify boot config:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$MNT</span>/boot/usercfg.txt<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s">kernel=vmlinux</span>
<span class="s">initramfs initrd.img followkernel</span>
<span class="s">boot_delay</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>Create a script to automatically decompress the kernel after an upgrade:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>&gt;<span class="nv">$MNT</span>/root/etc/kernel/postinst.d/zz-decompress-kernel<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">#!/bin/sh</span>

<span class="s">set -eu</span>

<span class="s">echo &quot;Updating decompressed kernel...&quot;</span>
<span class="s">[ -e /boot/firmware/vmlinux ] &amp;&amp; \</span>
<span class="s">    cp /boot/firmware/vmlinux /boot/firmware/vmlinux.bak</span>
<span class="s">vmlinuxtmp=$(mktemp /boot/firmware/vmlinux.XXXXXXXX)</span>
<span class="s">zcat -qf /boot/vmlinuz &gt; &quot;$vmlinuxtmp&quot;</span>
<span class="s">mv &quot;$vmlinuxtmp&quot; /boot/firmware/vmlinux</span>
<span class="s">EOF</span>

chmod<span class="w"> </span>+x<span class="w"> </span><span class="nv">$MNT</span>/root/etc/kernel/postinst.d/zz-decompress-kernel
</pre></div>
</div>
<p>Cleanup:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>umount<span class="w"> </span><span class="nv">$MNT</span>/*
rm<span class="w"> </span>-rf<span class="w"> </span><span class="nv">$MNT</span>
<span class="nb">exit</span>
</pre></div>
</div>
</li>
<li><p>Boot the Raspberry Pi.</p>
<p>Move the SD/USB disk to the Raspberry Pi. Boot it and login (e.g. via SSH)
with <code class="docutils literal notranslate"><span class="pre">ubuntu</span></code> as the username and password.  If you are using SSH, note
that it takes a little bit for cloud-init to enable password logins on the
first boot.  Set a new password when prompted and login again using that
password.  If you have your local SSH configured to use <code class="docutils literal notranslate"><span class="pre">ControlPersist</span></code>,
you will have to kill the existing SSH process before logging in the second
time.</p>
</li>
</ol>
</section>
<section id="step-2-setup-zfs">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Step 2: Setup ZFS</a><a class="headerlink" href="#step-2-setup-zfs" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Become root:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>-i
</pre></div>
</div>
</li>
<li><p>Set the DISK and DISKP variables again:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">DISK</span><span class="o">=</span>/dev/mmcblk0<span class="w">    </span><span class="c1"># microSD card</span>
<span class="nv">DISKP</span><span class="o">=</span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>p<span class="w">       </span><span class="c1"># microSD card</span>

<span class="nv">DISK</span><span class="o">=</span>/dev/sdX<span class="w">        </span><span class="c1"># USB disk</span>
<span class="nv">DISKP</span><span class="o">=</span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span><span class="w">        </span><span class="c1"># USB disk</span>
</pre></div>
</div>
<p><strong>WARNING:</strong> Device names can change when moving a device to a different
computer or switching the microSD card from a USB reader to a built-in
slot. Double check the device name before continuing.</p>
</li>
<li><p>Install ZFS:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt<span class="w"> </span>update

apt<span class="w"> </span>install<span class="w"> </span>pv<span class="w"> </span>zfs-initramfs
</pre></div>
</div>
<p><strong>Note:</strong> Since this is the first boot, you may get <code class="docutils literal notranslate"><span class="pre">Waiting</span> <span class="pre">for</span> <span class="pre">cache</span>
<span class="pre">lock</span></code> because <code class="docutils literal notranslate"><span class="pre">unattended-upgrades</span></code> is running in the background.
Wait for it to finish.</p>
</li>
<li><p>Create the root pool:</p>
<p>Choose one of the following options:</p>
<ul>
<li><p>Unencrypted:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span><span class="nv">ashift</span><span class="o">=</span><span class="m">12</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span><span class="nv">acltype</span><span class="o">=</span>posixacl<span class="w"> </span>-O<span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>off<span class="w"> </span>-O<span class="w"> </span><span class="nv">compression</span><span class="o">=</span>lz4<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span><span class="nv">dnodesize</span><span class="o">=</span>auto<span class="w"> </span>-O<span class="w"> </span><span class="nv">normalization</span><span class="o">=</span>formD<span class="w"> </span>-O<span class="w"> </span><span class="nv">relatime</span><span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span><span class="nv">xattr</span><span class="o">=</span>sa<span class="w"> </span>-O<span class="w"> </span><span class="nv">mountpoint</span><span class="o">=</span>/<span class="w"> </span>-R<span class="w"> </span>/mnt<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rpool<span class="w"> </span><span class="si">${</span><span class="nv">DISKP</span><span class="si">}</span><span class="m">2</span>
</pre></div>
</div>
</li>
</ul>
<p><strong>WARNING:</strong> Encryption has not yet been tested on the Raspberry Pi.</p>
<ul>
<li><p>ZFS native encryption:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span><span class="nv">ashift</span><span class="o">=</span><span class="m">12</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span><span class="nv">encryption</span><span class="o">=</span>aes-256-gcm<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span><span class="nv">keylocation</span><span class="o">=</span>prompt<span class="w"> </span>-O<span class="w"> </span><span class="nv">keyformat</span><span class="o">=</span>passphrase<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span><span class="nv">acltype</span><span class="o">=</span>posixacl<span class="w"> </span>-O<span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>off<span class="w"> </span>-O<span class="w"> </span><span class="nv">compression</span><span class="o">=</span>lz4<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span><span class="nv">dnodesize</span><span class="o">=</span>auto<span class="w"> </span>-O<span class="w"> </span><span class="nv">normalization</span><span class="o">=</span>formD<span class="w"> </span>-O<span class="w"> </span><span class="nv">relatime</span><span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span><span class="nv">xattr</span><span class="o">=</span>sa<span class="w"> </span>-O<span class="w"> </span><span class="nv">mountpoint</span><span class="o">=</span>/<span class="w"> </span>-R<span class="w"> </span>/mnt<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rpool<span class="w"> </span><span class="si">${</span><span class="nv">DISKP</span><span class="si">}</span><span class="m">2</span>
</pre></div>
</div>
</li>
<li><p>LUKS:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cryptsetup<span class="w"> </span>luksFormat<span class="w"> </span>-c<span class="w"> </span>aes-xts-plain64<span class="w"> </span>-s<span class="w"> </span><span class="m">512</span><span class="w"> </span>-h<span class="w"> </span>sha256<span class="w"> </span><span class="si">${</span><span class="nv">DISKP</span><span class="si">}</span><span class="m">2</span>
cryptsetup<span class="w"> </span>luksOpen<span class="w"> </span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part4<span class="w"> </span>luks1
zpool<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span><span class="nv">ashift</span><span class="o">=</span><span class="m">12</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span><span class="nv">acltype</span><span class="o">=</span>posixacl<span class="w"> </span>-O<span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>off<span class="w"> </span>-O<span class="w"> </span><span class="nv">compression</span><span class="o">=</span>lz4<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span><span class="nv">dnodesize</span><span class="o">=</span>auto<span class="w"> </span>-O<span class="w"> </span><span class="nv">normalization</span><span class="o">=</span>formD<span class="w"> </span>-O<span class="w"> </span><span class="nv">relatime</span><span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-O<span class="w"> </span><span class="nv">xattr</span><span class="o">=</span>sa<span class="w"> </span>-O<span class="w"> </span><span class="nv">mountpoint</span><span class="o">=</span>/<span class="w"> </span>-R<span class="w"> </span>/mnt<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rpool<span class="w"> </span>/dev/mapper/luks1
</pre></div>
</div>
</li>
</ul>
<p><strong>Notes:</strong></p>
<ul class="simple">
<li><p>The use of <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is recommended here because many drives
today have 4 KiB (or larger) physical sectors, even though they
present 512 B logical sectors. Also, a future replacement drive may
have 4 KiB physical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is desirable)
or 4 KiB logical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is required).</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">acltype=posixacl</span></code> enables POSIX ACLs globally. If you
do not want this, remove that option, but later add
<code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">acltype=posixacl</span></code> (note: lowercase “o”) to the <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">create</span></code>
for <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>, as <a class="reference external" href="https://askubuntu.com/questions/970886/journalctl-says-failed-to-search-journal-acl-operation-not-supported">journald requires ACLs</a>
Also, <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/nfs-utils/+bug/1779736">disabling ACLs apparently breaks umask handling with NFSv4</a>.</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">normalization=formD</span></code> eliminates some corner cases relating
to UTF-8 filename normalization. It also implies <code class="docutils literal notranslate"><span class="pre">utf8only=on</span></code>,
which means that only UTF-8 filenames are allowed. If you care to
support non-UTF-8 filenames, do not use this option. For a discussion
of why requiring UTF-8 filenames may be a bad idea, see <a class="reference external" href="http://utcc.utoronto.ca/~cks/space/blog/linux/ForcedUTF8Filenames">The problems
with enforced UTF-8 only filenames</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">recordsize</span></code> is unset (leaving it at the default of 128 KiB). If you
want to tune it (e.g. <code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">recordsize=1M</span></code>), see <a class="reference external" href="https://jrs-s.net/2019/04/03/on-zfs-recordsize/">these</a> <a class="reference external" href="http://blog.programster.org/zfs-record-size">various</a> <a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSFileRecordsizeGrowth">blog</a>
<a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSRecordsizeAndCompression">posts</a>.</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">relatime=on</span></code> is a middle ground between classic POSIX
<code class="docutils literal notranslate"><span class="pre">atime</span></code> behavior (with its significant performance impact) and
<code class="docutils literal notranslate"><span class="pre">atime=off</span></code> (which provides the best performance by completely
disabling atime updates). Since Linux 2.6.30, <code class="docutils literal notranslate"><span class="pre">relatime</span></code> has been
the default for other filesystems. See <a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/power_management_guide/relatime">RedHat’s documentation</a>
for further information.</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> <a class="reference external" href="https://github.com/zfsonlinux/zfs/commit/82a37189aac955c81a59a5ecc3400475adb56355">vastly improves the performance of extended
attributes</a>.
Inside ZFS, extended attributes are used to implement POSIX ACLs.
Extended attributes can also be used by user-space applications.
<a class="reference external" href="https://en.wikipedia.org/wiki/Extended_file_attributes#Linux">They are used by some desktop GUI applications.</a>
<a class="reference external" href="https://wiki.samba.org/index.php/Setting_up_a_Share_Using_Windows_ACLs">They can be used by Samba to store Windows ACLs and DOS attributes;
they are required for a Samba Active Directory domain controller.</a>
Note that <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> is <a class="reference external" href="https://openzfs.org/wiki/Platform_code_differences">Linux-specific</a>. If you move your
<code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> pool to another OpenZFS implementation besides ZFS-on-Linux,
extended attributes will not be readable (though your data will be). If
portability of extended attributes is important to you, omit the
<code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">xattr=sa</span></code> above. Even if you do not want <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> for the whole
pool, it is probably fine to use it for <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>.</p></li>
<li><p>Make sure to include the <code class="docutils literal notranslate"><span class="pre">-part4</span></code> portion of the drive path. If you
forget that, you are specifying the whole disk, which ZFS will then
re-partition, and you will lose the bootloader partition(s).</p></li>
<li><p>ZFS native encryption defaults to <code class="docutils literal notranslate"><span class="pre">aes-256-ccm</span></code>, but <a class="reference external" href="https://github.com/openzfs/zfs/commit/31b160f0a6c673c8f926233af2ed6d5354808393">the default has
changed upstream</a>
to <code class="docutils literal notranslate"><span class="pre">aes-256-gcm</span></code>. <a class="reference external" href="https://crypto.stackexchange.com/questions/6842/how-to-choose-between-aes-ccm-and-aes-gcm-for-storage-volume-encryption">AES-GCM seems to be generally preferred over AES-CCM</a>,
<a class="reference external" href="https://github.com/zfsonlinux/zfs/pull/9749#issuecomment-569132997">is faster now</a>,
and <a class="reference external" href="https://github.com/zfsonlinux/zfs/pull/9749">will be even faster in the future</a>.</p></li>
<li><p>For LUKS, the key size chosen is 512 bits. However, XTS mode requires two
keys, so the LUKS key is split in half. Thus, <code class="docutils literal notranslate"><span class="pre">-s</span> <span class="pre">512</span></code> means AES-256.</p></li>
<li><p>Your passphrase will likely be the weakest link. Choose wisely. See
<a class="reference external" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#5-security-aspects">section 5 of the cryptsetup FAQ</a>
for guidance.</p></li>
</ul>
</li>
</ol>
</section>
<section id="step-3-system-installation">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Step 3: System Installation</a><a class="headerlink" href="#step-3-system-installation" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Create a filesystem dataset to act as a container:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs<span class="w"> </span>create<span class="w"> </span>-o<span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>off<span class="w"> </span>-o<span class="w"> </span><span class="nv">mountpoint</span><span class="o">=</span>none<span class="w"> </span>rpool/ROOT
</pre></div>
</div>
</li>
<li><p>Create a filesystem dataset for the root filesystem:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/urandom<span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">100</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span>
<span class="w">    </span>tr<span class="w"> </span>-dc<span class="w"> </span><span class="s1">&#39;a-z0-9&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-c-6<span class="k">)</span>

zfs<span class="w"> </span>create<span class="w"> </span>-o<span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>noauto<span class="w"> </span>-o<span class="w"> </span><span class="nv">mountpoint</span><span class="o">=</span>/<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>com.ubuntu.zsys:bootfs<span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>com.ubuntu.zsys:last-used<span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%s<span class="k">)</span><span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>
zfs<span class="w"> </span>mount<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>
</pre></div>
</div>
<p>With ZFS, it is not normally necessary to use a mount command (either
<code class="docutils literal notranslate"><span class="pre">mount</span></code> or <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">mount</span></code>). This situation is an exception because of
<code class="docutils literal notranslate"><span class="pre">canmount=noauto</span></code>.</p>
</li>
<li><p>Create datasets:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs<span class="w"> </span>create<span class="w"> </span>-o<span class="w"> </span>com.ubuntu.zsys:bootfs<span class="o">=</span>no<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/srv
zfs<span class="w"> </span>create<span class="w"> </span>-o<span class="w"> </span>com.ubuntu.zsys:bootfs<span class="o">=</span>no<span class="w"> </span>-o<span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>off<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/usr
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/usr/local
zfs<span class="w"> </span>create<span class="w"> </span>-o<span class="w"> </span>com.ubuntu.zsys:bootfs<span class="o">=</span>no<span class="w"> </span>-o<span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>off<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/games
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/lib
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/lib/AccountsService
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/lib/apt
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/lib/dpkg
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/lib/NetworkManager
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/log
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/mail
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/snap
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/spool
zfs<span class="w"> </span>create<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/var/www

zfs<span class="w"> </span>create<span class="w"> </span>-o<span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>off<span class="w"> </span>-o<span class="w"> </span><span class="nv">mountpoint</span><span class="o">=</span>/<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rpool/USERDATA
zfs<span class="w"> </span>create<span class="w"> </span>-o<span class="w"> </span>com.ubuntu.zsys:bootfs-datasets<span class="o">=</span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>on<span class="w"> </span>-o<span class="w"> </span><span class="nv">mountpoint</span><span class="o">=</span>/root<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rpool/USERDATA/root_<span class="nv">$UUID</span>
</pre></div>
</div>
<p>If you want a separate dataset for <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs<span class="w"> </span>create<span class="w"> </span>-o<span class="w"> </span>com.ubuntu.zsys:bootfs<span class="o">=</span>no<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>/tmp
chmod<span class="w"> </span><span class="m">1777</span><span class="w"> </span>/mnt/tmp
</pre></div>
</div>
<p>The primary goal of this dataset layout is to separate the OS from user
data. This allows the root filesystem to be rolled back without rolling
back user data.</p>
<p>If you do nothing extra, <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> will be stored as part of the root
filesystem. Alternatively, you can create a separate dataset for <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>,
as shown above. This keeps the <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> data out of snapshots of your root
filesystem. It also allows you to set a quota on <code class="docutils literal notranslate"><span class="pre">rpool/tmp</span></code>, if you want
to limit the maximum space used. Otherwise, you can use a tmpfs (RAM
filesystem) later.</p>
</li>
<li><p>Optional: Ignore synchronous requests:</p>
<p>microSD cards are relatively slow.  If you want to increase performance
(especially when installing packages) at the cost of some safety, you can
disable flushing of synchronous requests (e.g. <code class="docutils literal notranslate"><span class="pre">fsync()</span></code>, <code class="docutils literal notranslate"><span class="pre">O_[D]SYNC</span></code>):</p>
<p>Choose one of the following options:</p>
<ul>
<li><p>For the root filesystem, but not user data:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">sync</span><span class="o">=</span>disabled<span class="w"> </span>rpool/ROOT
</pre></div>
</div>
</li>
<li><p>For everything:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">sync</span><span class="o">=</span>disabled<span class="w"> </span>rpool
</pre></div>
</div>
</li>
</ul>
<p>ZFS is transactional, so it will still be crash consistent.  However, you
should leave <code class="docutils literal notranslate"><span class="pre">sync</span></code> at its default of <code class="docutils literal notranslate"><span class="pre">standard</span></code> if this system needs
to guarantee persistence (e.g. if it is a database or NFS server).</p>
</li>
<li><p>Copy the system into the ZFS filesystems:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">(</span><span class="nb">cd</span><span class="w"> </span>/<span class="p">;</span><span class="w"> </span>tar<span class="w"> </span>-cf<span class="w"> </span>-<span class="w"> </span>--one-file-system<span class="w"> </span>--warning<span class="o">=</span>no-file-ignored<span class="w"> </span>.<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>pv<span class="w"> </span>-p<span class="w"> </span>-bs<span class="w"> </span><span class="k">$(</span>du<span class="w"> </span>-sxm<span class="w"> </span>--apparent-size<span class="w"> </span>/<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f1<span class="k">)</span>m<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">(</span><span class="nb">cd</span><span class="w"> </span>/mnt<span class="w"> </span><span class="p">;</span><span class="w"> </span>tar<span class="w"> </span>-x<span class="o">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="step-4-system-configuration">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Step 4: System Configuration</a><a class="headerlink" href="#step-4-system-configuration" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Configure the hostname:</p>
<p>Replace <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> with the desired hostname:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>hostname<span class="w"> </span>HOSTNAME
hostname<span class="w"> </span>&gt;<span class="w"> </span>/mnt/etc/hostname
vi<span class="w"> </span>/mnt/etc/hosts
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Add a line:
127.0.1.1       HOSTNAME
or if the system has a real name in DNS:
127.0.1.1       FQDN HOSTNAME
</pre></div>
</div>
<p><strong>Hint:</strong> Use <code class="docutils literal notranslate"><span class="pre">nano</span></code> if you find <code class="docutils literal notranslate"><span class="pre">vi</span></code> confusing.</p>
</li>
<li><p>Stop <code class="docutils literal notranslate"><span class="pre">zed</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>stop<span class="w"> </span>zed
</pre></div>
</div>
</li>
<li><p>Bind the virtual filesystems from the running environment to the new
ZFS environment and <code class="docutils literal notranslate"><span class="pre">chroot</span></code> into it:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mount<span class="w"> </span>--make-private<span class="w"> </span>--rbind<span class="w"> </span>/boot/firmware<span class="w"> </span>/mnt/boot/firmware
mount<span class="w"> </span>--make-private<span class="w"> </span>--rbind<span class="w"> </span>/dev<span class="w">  </span>/mnt/dev
mount<span class="w"> </span>--make-private<span class="w"> </span>--rbind<span class="w"> </span>/proc<span class="w"> </span>/mnt/proc
mount<span class="w"> </span>--make-private<span class="w"> </span>--rbind<span class="w"> </span>/run<span class="w">  </span>/mnt/run
mount<span class="w"> </span>--make-private<span class="w"> </span>--rbind<span class="w"> </span>/sys<span class="w">  </span>/mnt/sys
chroot<span class="w"> </span>/mnt<span class="w"> </span>/usr/bin/env<span class="w"> </span><span class="nv">DISK</span><span class="o">=</span><span class="nv">$DISK</span><span class="w"> </span><span class="nv">UUID</span><span class="o">=</span><span class="nv">$UUID</span><span class="w"> </span>bash<span class="w"> </span>--login
</pre></div>
</div>
</li>
<li><p>Configure a basic system environment:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt<span class="w"> </span>update
</pre></div>
</div>
<p>Even if you prefer a non-English system language, always ensure that
<code class="docutils literal notranslate"><span class="pre">en_US.UTF-8</span></code> is available:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>dpkg-reconfigure<span class="w"> </span>locales
dpkg-reconfigure<span class="w"> </span>tzdata
</pre></div>
</div>
</li>
<li><p>For LUKS installs only, setup <code class="docutils literal notranslate"><span class="pre">/etc/crypttab</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup is already installed, but this marks it as manually</span>
<span class="c1"># installed so it is not automatically removed.</span>
apt<span class="w"> </span>install<span class="w"> </span>--yes<span class="w"> </span>cryptsetup

<span class="nb">echo</span><span class="w"> </span>luks1<span class="w"> </span><span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>blkid<span class="w"> </span>-s<span class="w"> </span>UUID<span class="w"> </span>-o<span class="w"> </span>value<span class="w"> </span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part4<span class="k">)</span><span class="w"> </span>none<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>luks,discard,initramfs<span class="w"> </span>&gt;<span class="w"> </span>/etc/crypttab
</pre></div>
</div>
<p>The use of <code class="docutils literal notranslate"><span class="pre">initramfs</span></code> is a work-around for <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/cryptsetup/+bug/1612906">cryptsetup does not support
ZFS</a>.</p>
</li>
<li><p>Optional: Mount a tmpfs to <code class="docutils literal notranslate"><span class="pre">/tmp</span></code></p>
<p>If you chose to create a <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> dataset above, skip this step, as they
are mutually exclusive choices. Otherwise, you can put <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> on a
tmpfs (RAM filesystem) by enabling the <code class="docutils literal notranslate"><span class="pre">tmp.mount</span></code> unit.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cp<span class="w"> </span>/usr/share/systemd/tmp.mount<span class="w"> </span>/etc/systemd/system/
systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>tmp.mount
</pre></div>
</div>
</li>
<li><p>Setup system groups:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>addgroup<span class="w"> </span>--system<span class="w"> </span>lpadmin
addgroup<span class="w"> </span>--system<span class="w"> </span>sambashare
</pre></div>
</div>
</li>
<li><p>Patch a dependency loop:</p>
<p>For ZFS native encryption or LUKS:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt<span class="w"> </span>install<span class="w"> </span>--yes<span class="w"> </span>curl<span class="w"> </span>patch

curl<span class="w"> </span>https://launchpadlibrarian.net/478315221/2150-fix-systemd-dependency-loops.patch<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>sed<span class="w"> </span><span class="s2">&quot;s|/etc|/lib|;s|\.in</span>$<span class="s2">||&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">(</span><span class="nb">cd</span><span class="w"> </span>/<span class="w"> </span><span class="p">;</span><span class="w"> </span>patch<span class="w"> </span>-p1<span class="o">)</span>
</pre></div>
</div>
<p>Ignore the failure in Hunk #2 (say <code class="docutils literal notranslate"><span class="pre">n</span></code> twice).</p>
<p>This patch is from <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/zfs-linux/+bug/1875577">Bug #1875577 Encrypted swap won’t load on 20.04 with
zfs root</a>.</p>
</li>
<li><p>Fix filesystem mount ordering:</p>
<p>We need to activate <code class="docutils literal notranslate"><span class="pre">zfs-mount-generator</span></code>. This makes systemd aware of
the separate mountpoints, which is important for things like <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>
and <code class="docutils literal notranslate"><span class="pre">/var/tmp</span></code>. In turn, <code class="docutils literal notranslate"><span class="pre">rsyslog.service</span></code> depends on <code class="docutils literal notranslate"><span class="pre">var-log.mount</span></code>
by way of <code class="docutils literal notranslate"><span class="pre">local-fs.target</span></code> and services using the <code class="docutils literal notranslate"><span class="pre">PrivateTmp</span></code> feature
of systemd automatically use <code class="docutils literal notranslate"><span class="pre">After=var-tmp.mount</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>/etc/zfs/zfs-list.cache
touch<span class="w"> </span>/etc/zfs/zfs-list.cache/rpool
ln<span class="w"> </span>-s<span class="w"> </span>/usr/lib/zfs-linux/zed.d/history_event-zfs-list-cacher.sh<span class="w"> </span>/etc/zfs/zed.d
zed<span class="w"> </span>-F<span class="w"> </span><span class="p">&amp;</span>
</pre></div>
</div>
<p>Force a cache update:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>noauto<span class="w"> </span>rpool/ROOT/ubuntu_<span class="nv">$UUID</span>
</pre></div>
</div>
<p>Verify that <code class="docutils literal notranslate"><span class="pre">zed</span></code> updated the cache by making sure this is not empty,
which will take a few seconds:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>/etc/zfs/zfs-list.cache/rpool
</pre></div>
</div>
<p>Stop <code class="docutils literal notranslate"><span class="pre">zed</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">fg</span>
Press<span class="w"> </span>Ctrl-C.
</pre></div>
</div>
<p>Fix the paths to eliminate <code class="docutils literal notranslate"><span class="pre">/mnt</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sed<span class="w"> </span>-Ei<span class="w"> </span><span class="s2">&quot;s|/mnt/?|/|&quot;</span><span class="w"> </span>/etc/zfs/zfs-list.cache/*
</pre></div>
</div>
</li>
<li><p>Remove old filesystem from <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>vi<span class="w"> </span>/etc/fstab
<span class="c1"># Remove the old root filesystem line:</span>
<span class="c1">#   LABEL=writable / ext4 ...</span>
</pre></div>
</div>
</li>
<li><p>Configure kernel command line:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cp<span class="w"> </span>/boot/firmware/cmdline.txt<span class="w"> </span>/boot/firmware/cmdline.txt.bak
sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s|root=LABEL=writable rootfstype=ext4|root=ZFS=rpool/ROOT/ubuntu_</span><span class="nv">$UUID</span><span class="s2">|&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>/boot/firmware/cmdline.txt
sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s| fixrtc||&quot;</span><span class="w"> </span>/boot/firmware/cmdline.txt
sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s|</span>$<span class="s2">| init_on_alloc=0|&quot;</span><span class="w"> </span>/boot/firmware/cmdline.txt
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">fixrtc</span></code> script is not compatible with ZFS and will cause the boot
to hang for 180 seconds.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">init_on_alloc=0</span></code> is to address <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1862822">performance regressions</a>.</p>
</li>
<li><p>Optional (but highly recommended): Make debugging booting easier:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;s|</span>$<span class="s2">| nosplash|&quot;</span><span class="w"> </span>/boot/firmware/cmdline.txt
</pre></div>
</div>
</li>
<li><p>Reboot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">exit</span>
reboot
</pre></div>
</div>
<p>Wait for the newly installed system to boot normally. Login as <code class="docutils literal notranslate"><span class="pre">ubuntu</span></code>.</p>
</li>
</ol>
</section>
<section id="step-5-first-boot">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Step 5: First Boot</a><a class="headerlink" href="#step-5-first-boot" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Become root:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>-i
</pre></div>
</div>
</li>
<li><p>Set the DISK variable again:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">DISK</span><span class="o">=</span>/dev/mmcblk0<span class="w">    </span><span class="c1"># microSD card</span>

<span class="nv">DISK</span><span class="o">=</span>/dev/sdX<span class="w">        </span><span class="c1"># USB disk</span>
</pre></div>
</div>
</li>
<li><p>Delete the ext4 partition and expand the ZFS partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sfdisk<span class="w"> </span><span class="nv">$DISK</span><span class="w"> </span>--delete<span class="w"> </span><span class="m">3</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;, +&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sfdisk<span class="w"> </span>--no-reread<span class="w"> </span>-N<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="nv">$DISK</span>
</pre></div>
</div>
<p><strong>Note:</strong> This does not automatically expand the pool.  That will be happen
on reboot.</p>
</li>
<li><p>Create a user account:</p>
<p>Replace <code class="docutils literal notranslate"><span class="pre">YOUR_USERNAME</span></code> with your desired username:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">username</span><span class="o">=</span>YOUR_USERNAME

<span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/urandom<span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">100</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span>
<span class="w">    </span>tr<span class="w"> </span>-dc<span class="w"> </span><span class="s1">&#39;a-z0-9&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-c-6<span class="k">)</span>
<span class="nv">ROOT_DS</span><span class="o">=</span><span class="k">$(</span>zfs<span class="w"> </span>list<span class="w"> </span>-o<span class="w"> </span>name<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;/ROOT\/ubuntu_/{print $1;exit}&#39;</span><span class="k">)</span>
zfs<span class="w"> </span>create<span class="w"> </span>-o<span class="w"> </span>com.ubuntu.zsys:bootfs-datasets<span class="o">=</span><span class="nv">$ROOT_DS</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span><span class="nv">canmount</span><span class="o">=</span>on<span class="w"> </span>-o<span class="w"> </span><span class="nv">mountpoint</span><span class="o">=</span>/home/<span class="nv">$username</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rpool/USERDATA/<span class="si">${</span><span class="nv">username</span><span class="si">}</span>_<span class="nv">$UUID</span>
adduser<span class="w"> </span><span class="nv">$username</span>

cp<span class="w"> </span>-a<span class="w"> </span>/etc/skel/.<span class="w"> </span>/home/<span class="nv">$username</span>
chown<span class="w"> </span>-R<span class="w"> </span><span class="nv">$username</span>:<span class="nv">$username</span><span class="w"> </span>/home/<span class="nv">$username</span>
usermod<span class="w"> </span>-a<span class="w"> </span>-G<span class="w"> </span>adm,cdrom,dip,lpadmin,lxd,plugdev,sambashare,sudo<span class="w"> </span><span class="nv">$username</span>
</pre></div>
</div>
</li>
<li><p>Reboot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>reboot
</pre></div>
</div>
<p>Wait for the system to boot normally. Login using the account you
created.</p>
</li>
<li><p>Become root:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>-i
</pre></div>
</div>
</li>
<li><p>Expand the ZFS pool:</p>
<p>Verify the pool expanded:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs<span class="w"> </span>list<span class="w"> </span>rpool
</pre></div>
</div>
<p>If it did not automatically expand, try to expand it manually:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">DISK</span><span class="o">=</span>/dev/mmcblk0<span class="w">    </span><span class="c1"># microSD card</span>
<span class="nv">DISKP</span><span class="o">=</span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>p<span class="w">       </span><span class="c1"># microSD card</span>

<span class="nv">DISK</span><span class="o">=</span>/dev/sdX<span class="w">        </span><span class="c1"># USB disk</span>
<span class="nv">DISKP</span><span class="o">=</span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span><span class="w">        </span><span class="c1"># USB disk</span>

zpool<span class="w"> </span>online<span class="w"> </span>-e<span class="w"> </span>rpool<span class="w"> </span><span class="si">${</span><span class="nv">DISKP</span><span class="si">}</span><span class="m">2</span>
</pre></div>
</div>
</li>
<li><p>Delete the <code class="docutils literal notranslate"><span class="pre">ubuntu</span></code> user:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>deluser<span class="w"> </span>--remove-home<span class="w"> </span>ubuntu
</pre></div>
</div>
</li>
</ol>
</section>
<section id="step-6-full-software-installation">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">Step 6: Full Software Installation</a><a class="headerlink" href="#step-6-full-software-installation" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Optional: Remove cloud-init:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>vi<span class="w"> </span>/etc/netplan/01-netcfg.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">network</span><span class="p">:</span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">ethernets</span><span class="p">:</span>
<span class="w">    </span><span class="nt">eth0</span><span class="p">:</span>
<span class="w">      </span><span class="nt">dhcp4</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>rm<span class="w"> </span>/etc/netplan/50-cloud-init.yaml
apt<span class="w"> </span>purge<span class="w"> </span>--autoremove<span class="w"> </span>^cloud-init
rm<span class="w"> </span>-rf<span class="w"> </span>/etc/cloud
</pre></div>
</div>
</li>
<li><p>Optional: Remove other storage packages:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt<span class="w"> </span>purge<span class="w"> </span>--autoremove<span class="w"> </span>bcache-tools<span class="w"> </span>btrfs-progs<span class="w"> </span>cloud-guest-utils<span class="w"> </span>lvm2<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>mdadm<span class="w"> </span>multipath-tools<span class="w"> </span>open-iscsi<span class="w"> </span>overlayroot<span class="w"> </span>xfsprogs
</pre></div>
</div>
</li>
<li><p>Upgrade the minimal system:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt<span class="w"> </span>dist-upgrade<span class="w"> </span>--yes
</pre></div>
</div>
</li>
<li><p>Optional: Install a full GUI environment:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt<span class="w"> </span>install<span class="w"> </span>--yes<span class="w"> </span>ubuntu-desktop
<span class="nb">echo</span><span class="w"> </span><span class="nv">dtoverlay</span><span class="o">=</span>vc4-fkms-v3d<span class="w"> </span>&gt;&gt;<span class="w"> </span>/boot/firmware/usercfg.txt
</pre></div>
</div>
<p><strong>Hint</strong>: If you are installing a full GUI environment, you will likely
want to remove cloud-init as discussed above but manage your network with
NetworkManager:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>rm<span class="w"> </span>/etc/netplan/*.yaml
vi<span class="w"> </span>/etc/netplan/01-network-manager-all.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">network</span><span class="p">:</span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">renderer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkManager</span>
</pre></div>
</div>
</li>
<li><p>Optional (but recommended): Disable log compression:</p>
<p>As <code class="docutils literal notranslate"><span class="pre">/var/log</span></code> is already compressed by ZFS, logrotate’s compression is
going to burn CPU and disk I/O for (in most cases) very little gain. Also,
if you are making snapshots of <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>, logrotate’s compression will
actually waste space, as the uncompressed data will live on in the
snapshot. You can edit the files in <code class="docutils literal notranslate"><span class="pre">/etc/logrotate.d</span></code> by hand to comment
out <code class="docutils literal notranslate"><span class="pre">compress</span></code>, or use this loop (copy-and-paste highly recommended):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>file<span class="w"> </span><span class="k">in</span><span class="w"> </span>/etc/logrotate.d/*<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>grep<span class="w"> </span>-Eq<span class="w"> </span><span class="s2">&quot;(^|[^#y])compress&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>sed<span class="w"> </span>-i<span class="w"> </span>-r<span class="w"> </span><span class="s2">&quot;s/(^|[^#y])(compress)/\1#\2/&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>
</pre></div>
</div>
</li>
<li><p>Reboot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>reboot
</pre></div>
</div>
</li>
</ol>
</section>
<section id="step-7-final-cleanup">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Step 7: Final Cleanup</a><a class="headerlink" href="#step-7-final-cleanup" title="Link to this heading"></a></h2>
<ol class="arabic">
<li><p>Wait for the system to boot normally. Login using the account you
created. Ensure the system (including networking) works normally.</p></li>
<li><p>Optional: For LUKS installs only, backup the LUKS header:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>cryptsetup<span class="w"> </span>luksHeaderBackup<span class="w"> </span>/dev/disk/by-id/scsi-SATA_disk1-part4<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--header-backup-file<span class="w"> </span>luks1-header.dat
</pre></div>
</div>
<p>Store that backup somewhere safe (e.g. cloud storage). It is protected by
your LUKS passphrase, but you may wish to use additional encryption.</p>
<p><strong>Hint:</strong> If you created a mirror or raidz topology, repeat this for each
LUKS volume (<code class="docutils literal notranslate"><span class="pre">luks2</span></code>, etc.).</p>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Ubuntu%2020.04%20Root%20on%20ZFS.html" class="btn btn-neutral float-left" title="Ubuntu 20.04 Root on ZFS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Ubuntu%2022.04%20Root%20on%20ZFS.html" class="btn btn-neutral float-right" title="Ubuntu 22.04 Root on ZFS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, OpenZFS.
      <span class="lastupdated">Last updated on Jan 25, 2026.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>